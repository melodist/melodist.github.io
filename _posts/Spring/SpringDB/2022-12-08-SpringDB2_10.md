---
layout: post
title: 스프링 DB 2편 - 10. 스프링 트랜잭션 전파1 - 기본
tags: [Spring, SpringDB2, UF]
permalink:  docs Spring SpringDB2_10
date: 2022-12-08 23:06:00
---
# 스프링 트랜잭션 전파1 - 기본
## 스프링 트랜잭션 전파1 - 커밋, 롤백

**BasicTxTest**
```java
import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.context.TestConfiguration;
import org.springframework.context.annotation.Bean;
import org.springframework.jdbc.datasource.DataSourceTransactionManager;
import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.transaction.TransactionStatus;
import org.springframework.transaction.interceptor.DefaultTransactionAttribute;

import javax.sql.DataSource;

@Slf4j
@SpringBootTest
public class BasicTxTest {
  
    @Autowired
    PlatformTransactionManager txManager;
  
    @TestConfiguration
    static class Config {
        @Bean
        public PlatformTransactionManager transactionManager(DataSource dataSource) {
            return new DataSourceTransactionManager(dataSource);
        }
    }
  
    @Test
    void commit() {
        log.info("트랜잭션 시작");
        TransactionStatus status = txManager.getTransaction(new DefaultTransactionAttribute());
      
        log.info("트랜잭션 커밋 시작");
        txManager.commit(status);
        log.info("트랜잭션 커밋 완료");
    }
  
    @Test
    void rollback() {
        log.info("트랜잭션 시작");
        TransactionStatus status = txManager.getTransaction(new DefaultTransactionAttribute());
      
        log.info("트랜잭션 롤백 시작");
        txManager.rollback(status);
        log.info("트랜잭션 롤백 완료");
    }
}
```

- `@TestConfiguration`: 해당 테스트에서 필요한 스프링 설정을 추가
- `DataSourceTransactionManager`를 스프링 빈으로 등록. 이후 트랜잭션 매니저인 `PlatformTransactionManager`를 주입 받으면 방금 등록한 `DataSourceTransactionManager`가 주입됨

**실행하기 전에 트랜잭션 관련 로그를 확인할 수 있도록 다음을 추가**
`application.properties` 추가
```properties
logging.level.org.springframework.transaction.interceptor=TRACE
logging.level.org.springframework.jdbc.datasource.DataSourceTransactionManager=DEBUG
#JPA log
logging.level.org.springframework.orm.jpa.JpaTransactionManager=DEBUG
logging.level.org.hibernate.resource.transaction=DEBUG
#JPA SQL
logging.level.org.hibernate.SQL=DEBUG
```

**commit()**
`txManager.getTransaction(new DefaultTransactionAttribute())`
트랜잭션 매니저를 통해 트랜잭션을 시작(획득)

`txManager.commit(status)`
트랜잭션을 커밋

**commit() - 실행 로그**
```
ringtx.propagation.BasicTxTest : 트랜잭션 시작
DataSourceTransactionManager : Creating new transaction with name [null]
DataSourceTransactionManager : Acquired Connection [conn0] for JDBC
transaction
DataSourceTransactionManager : Switching JDBC Connection [conn0] to manual commit
ringtx.propagation.BasicTxTest : 트랜잭션 커밋 시작
DataSourceTransactionManager : Initiating transaction commit
DataSourceTransactionManager : Committing JDBC transaction on Connection [conn0]
DataSourceTransactionManager : Releasing JDBC Connection [conn0] after transaction
ringtx.propagation.BasicTxTest : 트랜잭션 커밋 완료
```

**rollback()**
`txManager.getTransaction(new DefaultTransactionAttribute())`
트랜잭션 매니저를 통해 트랜잭션을 시작(획득)

`txManager.rollback(status)`
트랜잭션을 롤백

**rollback() - 실행 로그**
```
ringtx.propagation.BasicTxTest : 트랜잭션 시작
DataSourceTransactionManager : Creating new transaction with name [null]
DataSourceTransactionManager : Acquired Connection [conn0] for JDBC
transaction
DataSourceTransactionManager : Switching JDBC Connection [conn0] to manual commit
ringtx.propagation.BasicTxTest : 트랜잭션 롤백 시작
DataSourceTransactionManager : Initiating transaction rollback
DataSourceTransactionManager : Rolling back JDBC transaction on Connection [conn0]
DataSourceTransactionManager : Releasing JDBC Connection [conn0] after transaction
ringtx.propagation.BasicTxTest : 트랜잭션 롤백 완료
```

## 스프링 트랜잭션 전파2 - 트랜잭션 두 번 사용
## 스프링 트랜잭션 전파3 - 전파 기본
## 스프링 트랜잭션 전파4 - 전파 예제
## 스프링 트랜잭션 전파5 - 외부 롤백
## 스프링 트랜잭션 전파6 - 내부 롤백
## 스프링 트랜잭션 전파7 - REQUIRES_NEW
## 스프링 트랜잭션 전파8 - 다양한 전파 옵션