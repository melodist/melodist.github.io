---
layout: post
title: 스프링 MVC 2편 - 백엔드 웹 개발 활용 기술 - 6. 로그인 처리1 - 쿠키, 세션
tags: [Spring, SpringMVC2, UF]
permalink: /docs/Spring/SpringMVC2_6
date: 2022-04-28 23:32:00
---
# 로그인 처리1 - 쿠키, 세션

## 로그인 처리하기 - 쿠키 사용

### 로그인 상태 유지하기

- 서버에서 로그인에 성공하면 HTTP 응답에 쿠키를 담아서 브라우저에 전달
- 브라우저는 해당 쿠키를 지속적으로 요청에 담음

**쿠키 생성**
![로그인 처리1 - 쿠키, 세션 - 01  쿠키 사용](https://user-images.githubusercontent.com/52024566/165963257-e10e5cf3-7304-4ee5-a2ce-db1bbd864c6d.png)

**클라이언트 쿠키 전달1**
![로그인 처리1 - 쿠키, 세션 - 02  쿠키 사용](https://user-images.githubusercontent.com/52024566/165963261-a0389264-99e7-4d00-b45c-e732b8bad614.png)

**클라이언트 쿠키 전달2**
![로그인 처리1 - 쿠키, 세션 - 03  쿠키 사용](https://user-images.githubusercontent.com/52024566/165963263-c75b863a-31db-4044-a143-0482dd397105.png)

- 영속 쿠키: 만료 날짜를 입력하면 해당 날짜까지 유지
- 세션 쿠키: 만료 날짜를 생략하면 브라우저 종료시 까지만 유지

**쿠키 생성 로직**
```java
Cookie idCookie = new Cookie("memberId", String.valueOf(loginMember.getId()));
response.addCookie(idCookie);
```
- 로그인에 성공하면 쿠키를 생성하고 `HttpServletResponse`에 포함

**로그인 처리**
```java
@GetMapping("/")
public String homeLogin(
@CookieValue(name = "memberId", required = false) Long memberId,
Model model)
```
- `@CookieValue`를 사용하여 쿠키 조회
- 로그인하지 않은 사용자도 접근할 수 있도록 `required = false`

### 로그아웃
- 세션 쿠키이므로 웹 브라우저 종료시 서버에서 해당 쿠키의 종료 날짜를 0으로 지정

```java
@PostMapping("/logout")
public String logout(HttpServletResponse response) {
    expireCookie(response, "memberId");
    return "redirect:/";
}

private void expireCookie(HttpServletResponse response, String cookieName) {
    Cookie cookie = new Cookie(cookieName, null);
    cookie.setMaxAge(0);
    response.addCookie(cookie);
}
```
- `Max-Age=0`으로 설정하여 해당 쿠키는 즉시 종료

## 쿠키와 보안 문제

### 보안 문제
- 쿠키 값은 임의로 변경할 수 있음
  - 클라이언트가 쿠키를 강제로 변경하면 다른 사용자가 됨
  - `Cookie: memberId=1` → `Cookie: memberId=2` (다른 사용자의 이름이 보임)
- 쿠키에 보관된 정보는 훔쳐갈 수 있음
  - 만약 쿠키에 개인정보나, 신용카드 정보가 있다면?
  - 이 정보가 웹 브라우저에도 보관되고, 네트워크 요청마다 계속 클라이언트에서 서버로 전달
- 해커가 쿠키를 한번 훔쳐가면 평생 사용할 수 있음
  - 해커가 쿠키를 훔쳐가서 그 쿠키로 악의적인 요청을 계속 시도할 수 있음

### 대안
- 쿠키에 중요한 값을 노출하지 않고, 사용자 별로 예측 불가능한 임의의 토큰(랜덤 값)을 노출하고, 서버에서 토큰과 사용자 id를 매핑해서 인식, 그리고 서버에서 토큰을 관리
- 토큰은 해커가 임의의 값을 넣어도 찾을 수 없도록 예상 불가능 해야 함
- 해커가 토큰을 털어가도 시간이 지나면 사용할 수 없도록 서버에서 해당 토큰의 만료시간을 짧게(예: 30분) 유지
- 해킹이 의심되는 경우 서버에서 해당 토큰을 강제로 제거

## 로그인 처리하기 - 세션 동작 방식

## 로그인 처리하기 - 세션 직접 만들기

## 로그인 처리하기 - 직접 만든 세션 적용

## 로그인 처리하기 - 서블릿 HTTP 세션1

## 로그인 처리하기 - 서블릿 HTTP 세션2

## 세션 정보와 타임아웃 설정